{% extends 'base.html' %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
    :root {
        /* Light Theme */
        --bg-light: linear-gradient(120deg, #f8fafc 0%, #e0e7ef 100%);
        --card-bg-light: #fff;
        --text-light: #1e293b;
        --border-light: #cbd5e1;

        /* Dark Green Theme */
        --bg-dark: linear-gradient(120deg, #0a1c13 0%, #173d2a 100%); /* Darker green background */
        --card-bg-dark: #173d2a; /* Dark green card background */
        --text-dark: #e6ffe6; /* Light green text */
        --border-dark: #3a6b4a; /* Slightly lighter dark green border */
        --primary: #4CAF50; /* Primary green for accents and buttons */
        --primary-hover: #45a049; /* Darker green on hover */
    }

    body {
        background: var(--bg-light);
        min-height: 100vh;
        font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
        transition: background 0.5s ease-in-out;
    }

    body.dark {
        background: var(--bg-dark);
    }

    .center-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 0;
    }

    .card {
        border-radius: 1.5rem;
        border: none;
        background: var(--card-bg-light);
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
        max-width: 440px;
        width: 100%;
        transition: background 0.5s ease-in-out, box-shadow 0.3s ease;
    }

    body.dark .card {
        background: var(--card-bg-dark);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); /* Darker shadow for dark theme */
    }

    .form-label {
        font-weight: 600;
        color: var(--text-light);
        margin-bottom: 0.25rem;
    }

    body.dark .form-label {
        color: var(--text-dark);
    }

    .input-group-text {
        background: transparent;
        border: none;
        color: #64748b;
    }

    .form-control,
    .form-select {
        border-radius: 0.75rem;
        padding-left: 2.5rem;
        border: 1px solid var(--border-light);
        background: #f8fafc;
        color: var(--text-light);
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-control:hover,
    .form-select:hover {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.08rem rgba(76, 175, 80, 0.2); /* Green shadow on hover */
    }

    .form-select {
        padding-left: 1rem; /* Adjust padding for select to remove icon space */
    }

    body.dark .form-control,
    body.dark .form-select {
        background: #0f1c13; /* Darker green input background */
        color: var(--text-dark);
        border: 1px solid var(--border-dark);
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.18rem rgba(76, 175, 80, 0.25); /* Stronger green shadow on focus */
        background: #fff;
    }

    body.dark .form-control:focus,
    body.dark .form-select:focus {
        background: #0a1c13; /* Even darker green on focus in dark mode */
    }

    .position-relative .input-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        z-index: 2;
        color: #94a3b8;
        font-size: 1.15rem;
    }
    /* Specific adjustment for input-icon when form-select is used right after it */
    .form-select + .input-icon { /* This is not standard but to prevent overlapping if select has a custom icon */
        display: none; /* Hide icon for select elements if it clashes */
    }


    body.dark .position-relative .input-icon {
        color: #a3d9b4; /* Lighter icon color in dark mode */
    }

    .theme-toggle {
        position: absolute;
        right: 1.5rem;
        top: 1.5rem;
        cursor: pointer;
        font-size: 1.3rem;
        color: #64748b;
        transition: color 0.2s ease-in-out;
        z-index: 10;
    }

    .theme-toggle:hover {
        color: var(--primary);
    }

    .logo-img {
        width: 60px;
        height: 60px;
        object-fit: contain;
        border-radius: 50%;
        background: #f1f5f9;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.07);
    }

    body.dark .logo-img {
        background: #0a1c13;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .form-section-title {
        font-weight: 600;
        font-size: 1.1rem;
        margin: 2rem 0 0.8rem 0;
        color: var(--primary);
        letter-spacing: 0.01em;
    }

    .divider {
        margin: 2.5rem 0 2rem 0;
        border-top: 2px dashed rgba(100, 116, 139, 0.2);
    }

    body.dark .divider {
        border-color: rgba(76, 175, 80, 0.3); /* Green dashed line in dark mode */
    }

    .btn-primary {
        background: var(--primary);
        border: none;
        border-radius: 1rem;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15); /* Green shadow for button */
    }

    .btn-primary:hover,
    .btn-primary:focus {
        background: var(--primary-hover);
        box-shadow: 0 6px 18px rgba(76, 175, 80, 0.25); /* Darker green shadow on hover */
    }

    .alert {
        font-size: 0.98rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    /* Specific alert styles for better dark mode visibility */
    .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }
    body.dark .alert-success {
        background-color: #28a74533; /* Slightly transparent dark green */
        border-color: #218838;
        color: #e6ffe6;
    }

    .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
    body.dark .alert-danger {
        background-color: #dc354533;
        border-color: #c82333;
        color: #fff0f0;
    }

    .text-secondary {
        color: var(--primary) !important; /* Use primary green for secondary text */
    }

    .form-control::placeholder {
        color: #b6bbc7;
        opacity: 1;
    }

    body.dark .form-control::placeholder {
        color: #64748b;
    }

    .small {
        font-size: 0.97rem;
    }

    /* Custom styles for dynamic sections */
    .dynamic-form-section {
        display: none; /* Hidden by default */
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid var(--border-light); /* Using your theme variable */
    }
    body.dark .dynamic-form-section {
        border-color: var(--border-dark);
    }
    .dynamic-form-section h5 {
        color: var(--primary); /* Using your primary color for titles */
        margin-bottom: 20px;
        font-weight: 600;
    }
    .info-text {
        font-size: 0.9em;
        color: #6c757d;
        margin-bottom: 10px;
    }
    body.dark .info-text {
        color: #b0c9b0; /* Lighter text for dark mode info */
    }
    .text-success.fw-bold, .text-primary.fw-bold, .text-danger.fw-bold {
        /* Ensure these colors work well with your dark/light themes */
        color: var(--primary) !important; /* Forces green from your theme */
    }
    body.dark .text-danger.fw-bold {
        color: #ff6b6b !important; /* Slightly brighter red for dark mode */
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const prefersDark = localStorage.getItem('theme') === 'dark';
    if (prefersDark) document.body.classList.add('dark');

    const toggleBtn = document.getElementById('toggleTheme');
    toggleBtn?.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    });

    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');
    togglePassword?.addEventListener('click', () => {
        const type = passwordInput.type === 'password' ? 'text' : 'password';
        passwordInput.type = type;
        togglePassword.classList.toggle('bi-eye');
        togglePassword.classList.toggle('bi-eye-slash');
    });

    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    const confirmPasswordInput = document.getElementById('confirm_password');
    toggleConfirmPassword?.addEventListener('click', () => {
        const type = confirmPasswordInput.type === 'password' ? 'text' : 'password';
        confirmPasswordInput.type = type;
        toggleConfirmPassword.classList.toggle('bi-eye');
        toggleConfirmPassword.classList.toggle('bi-eye-slash');
    });

    const roleSelect = document.getElementById('role');
    const investorDetails = document.getElementById('investorDetails');
    const landbuyerDetails = document.getElementById('landbuyerDetails');

    function hideAllSections() {
        investorDetails.style.display = 'none';
        landbuyerDetails.style.display = 'none';
    }

    function setRequired(elements, isRequired) {
        elements.forEach(el => {
            if (el) el.required = isRequired;
        });
    }

    const investorInputs = [
        document.getElementById('investmentAmount'),
        document.getElementById('tenure'),
        document.getElementById('payout'),
        document.getElementById('paymentModeInvestor')
    ];

    const landbuyerInputs = [
        document.getElementById('plotReference'),
        document.getElementById('location'),
        document.getElementById('clientName'),
        document.getElementById('clientID'),
        document.getElementById('clientPhone'),
        document.getElementById('clientEmail')
    ];

    roleSelect.addEventListener('change', function () {
        hideAllSections();
        setRequired(investorInputs, false);
        setRequired(landbuyerInputs, false);

        if (this.value === 'investor') {
            investorDetails.style.display = 'block';
            setRequired(investorInputs, true);
        } else if (this.value === 'landbuyer') {
            landbuyerDetails.style.display = 'block';
            setRequired(landbuyerInputs, true);
        }
    });

    hideAllSections(); // Initial hide

    const registrationForm = document.getElementById('registrationForm');

    function showAlert(message, type) {
        const alertPlaceholder = document.createElement('div');
        alertPlaceholder.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
        document.querySelector('.card-body').prepend(alertPlaceholder);
        setTimeout(() => {
            const alert = alertPlaceholder.querySelector('.alert');
            if (alert) new bootstrap.Alert(alert).close();
        }, 5000);
    }

    registrationForm.addEventListener('submit', async function (event) {
        event.preventDefault();

        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (password !== confirmPassword) {
            confirmPasswordInput.setCustomValidity('Passwords do not match.');
        } else {
            confirmPasswordInput.setCustomValidity('');
        }

        if (!registrationForm.checkValidity()) {
            registrationForm.classList.add('was-validated');
            return;
        }

        registrationForm.classList.remove('was-validated');

        const submitButton = registrationForm.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = 'Registering...';

        try {
            const requestBody = {
                full_name: document.getElementById('full_name').value,
                email: document.getElementById('email').value,
                password: password,
                id_number: document.getElementById('id_number').value,
                phone_number: document.getElementById('phone_number').value,
                role: roleSelect.value,
                next_of_kin_name: document.getElementById('next_of_kin_name').value,
                next_of_kin_phone: document.getElementById('next_of_kin_phone').value
            };

            if (roleSelect.value === 'investor') {
                requestBody.investmentAmount = parseFloat(document.getElementById('investmentAmount').value);
                requestBody.tenure = document.getElementById('tenure').value;
                requestBody.payout = document.getElementById('payout').value;
                requestBody.paymentModeInvestor = document.getElementById('paymentModeInvestor').value;
            } else if (roleSelect.value === 'landbuyer') {
                requestBody.plotReference = document.getElementById('plotReference').value;
                requestBody.location = document.getElementById('location').value;
                requestBody.clientName = document.getElementById('clientName').value;
                requestBody.clientID = document.getElementById('clientID').value;
                requestBody.clientPhone = document.getElementById('clientPhone').value;
                requestBody.clientEmail = document.getElementById('clientEmail').value;
            }

            const response = await fetch('/api/signup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            if (response.ok) {
                showAlert(data.message || 'Registration successful! Redirecting...', 'success');
                setTimeout(() => {
                    window.location.href = "{{ url_for('main.login') }}";
                }, 2000);
            } else {
                showAlert(data.message || 'Registration failed. Please try again.', 'danger');
            }
        } catch (error) {
            console.error('Registration error:', error);
            showAlert('An unexpected error occurred. Please check your network connection.', 'danger');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = originalText;
        }
    });
});
</script>



<div class="center-container position-relative">
    <i id="toggleTheme" class="bi bi-circle-half theme-toggle" title="Toggle Dark/Light Mode"></i>
    <div class="card shadow-lg">
        <div class="card-body px-4 py-5 p-md-5">
            <div class="text-center mb-4">
                <h2 class="fw-bold mb-1" style="letter-spacing:0.01em;">Create Account</h2>
                <p class="text-muted mb-0">Join <span class="text-secondary fw-bold">AMSA Group</span> today</p>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-${category} alert-dismissible fade show" role="alert">
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <form id="registrationForm"> {# Wrapped the entire form within the form tag #}
                {# Removed CSRF hidden input field #}
                {# <input type="hidden" id="csrf_token" name="csrf_token" value="{{ csrf_token() }}"> #}

                <div class="row g-3">
                    <div class="col-12 position-relative mb-3">
                        <label for="full_name" class="form-label">Full Name</label>
                        <i class="bi bi-person-fill input-icon"></i>
                        <input type="text" class="form-control form-control-lg" id="full_name" name="full_name" placeholder="Your full name" required>
                        <div class="invalid-feedback">Please enter your full name.</div>
                    </div>
                    <div class="col-12 position-relative mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <i class="bi bi-envelope-fill input-icon"></i>
                        <input type="email" class="form-control form-control-lg" id="email" name="email" placeholder="Your email" required>
                        <div class="invalid-feedback">Please enter a valid email address.</div>
                    </div>
                    <div class="col-12 position-relative mb-3">
                        <label for="password" class="form-label">Password</label>
                        <i class="bi bi-lock-fill input-icon"></i>
                        <input type="password" class="form-control form-control-lg" id="password" name="password" placeholder="Create a password" required>
                        <i class="bi bi-eye-slash position-absolute" id="togglePassword" style="top: 50%; right: 1rem; cursor: pointer; transform: translateY(-50%);"></i>
                        <div class="invalid-feedback">Please create a password.</div>
                    </div>

                    {# START OF CORRECTION: ADDED CONFIRM PASSWORD FIELD #}
                    <div class="col-12 position-relative mb-3">
                        <label for="confirm_password" class="form-label">Confirm Password</label>
                        <i class="bi bi-lock-fill input-icon"></i>
                        <input type="password" class="form-control form-control-lg" id="confirm_password" name="confirm_password" placeholder="Confirm your password" required>
                        <i class="bi bi-eye-slash position-absolute" id="toggleConfirmPassword" style="top: 50%; right: 1rem; cursor: pointer; transform: translateY(-50%);"></i>
                        <div class="invalid-feedback">Passwords do not match.</div>
                    </div>
                    {# END OF CORRECTION #}

                    <div class="col-12 position-relative mb-3">
                        <label for="role" class="form-label">I am registering as:</label>
                        <select class="form-select form-select-lg" id="role" name="role" required>
                            <option value="" disabled selected>Select Role</option>
                            <option value="investor">Investor</option>
                            
                        </select>
                        <div class="invalid-feedback">Please select a role.</div>
                    </div>
                    <div class="col-12 position-relative mb-3">
                        <label for="id_number" class="form-label">ID Number</label>
                        <i class="bi bi-card-heading input-icon"></i>
                        <input type="text" class="form-control form-control-lg" id="id_number" name="id_number" placeholder="National ID or Passport" required>
                        <div class="invalid-feedback">Please enter your ID number.</div>
                    </div>
                    <div class="col-12 position-relative mb-3">
                        <label for="phone_number" class="form-label">Phone Number</label>
                        <i class="bi bi-telephone-fill input-icon"></i>
                        <input type="tel" class="form-control form-control-lg" id="phone_number" name="phone_number" placeholder="07XXXXXXXX" required>
                        <div class="invalid-feedback">Please enter your phone number.</div>
                    </div>
                </div>

<!--                 <div id="investorDetails" class="dynamic-form-section">
                    <h5 class="mb-3">Investment Details</h5>

                    <div class="mb-3">
                        <label for="investmentAmount" class="form-label">Desired Investment Amount (KES)</label>
                        <input type="number" class="form-control form-control-lg" id="investmentAmount" name="investmentAmount"  min="0" step="any">
                        <small class="form-text info-text">Enter the amount you are looking to invest.</small>
                        <div class="invalid-feedback">Please enter a valid investment amount.</div>
                    </div>

                   

                    <div class="mb-3">
                        <label for="tenure" class="form-label">Preferred Tenure</label>
                        <select class="form-select form-select-lg" id="tenure" name="tenure">
                            <option value="" selected disabled>Choose Tenure</option>
                            <option value="6months">6 Months</option>
                            <option value="12months">12 Months</option>
                            <option value="24months">24 Months</option>
                        </select>
                        <div class="invalid-feedback">Please select a preferred tenure.</div>
                    </div>

                    <div class="mb-3">
                        <label for="payout" class="form-label">Preferred Payout Frequency</label>
                        <select class="form-select form-select-lg" id="payout" name="payout">
                            <option value="" selected disabled>Choose Payout</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="atmaternity">At Maturity</option>
                        </select>
                        <div class="invalid-feedback">Please select a preferred payout frequency.</div>
                    </div>

                    <div class="mb-3">
                        <label for="paymentModeInvestor" class="form-label">Preferred Payment Mode</label>
                        <select class="form-select form-select-lg" id="paymentModeInvestor" name="paymentModeInvestor">
                            <option value="" selected disabled>Choose Payment Mode</option>
                            <option value="bank">Bank Transfer</option>
                            <option value="mpesa">M-PESA</option>
                        </select>
                        <div class="invalid-feedback">Please select a preferred payment mode.</div>
                    </div>
                </div> -->

<!--                 <div id="landbuyerDetails" class="dynamic-form-section">
                    <h5 class="mb-3">Land Purchase Details</h5>

                    <div class="mb-3">
                        <label for="plotReference" class="form-label">Plot Reference (If known)</label>
                        <input type="text" class="form-control form-control-lg" id="plotReference" name="plotReference" placeholder="e.g., PLOT-001, RUIRU-EX05">
                        <small class="form-text info-text">Enter a specific plot reference if you have one, or leave blank to browse.</small>
                        <div class="invalid-feedback">Please enter a plot reference or leave blank.</div>
                    </div>

                    <div class="mb-3">
                        <label for="location" class="form-label">Desired Location</label>
                        <input type="text" class="form-control form-control-lg" id="location" name="location" placeholder="e.g., Kajiado, Isinya, Ruiru">
                        <small class="form-text info-text">Which area are you interested in?</small>
                        <div class="invalid-feedback">Please enter a desired location.</div>
                    </div>

                    <div class="mb-3">
                        <p class="mb-1">**Typical Price Range:** <span class="fw-bold text-primary">KES [Amount]</span> (Varies by plot)</p>
                        <p class="info-text">Specific plot prices will be provided upon inquiry or plot selection.</p>
                    </div>

                    <div class="mb-3">
                        <p class="mb-1">**Installment Plan Available:**</p>
                        <p class="info-text">Flexible installment options are available. Detailed plans will be discussed based on your chosen plot.</p>
                    </div>

                    <div class="mb-4">
                        <p class="mb-1">**Booking Fee:** <span class="fw-bold text-danger">KES 7,500</span></p>
                        <p class="info-text">This non-refundable fee secures your plot during the processing period.</p>
                    </div>

                    <hr class="my-4">

                    <h5 class="mb-3">Your Contact Information for Land Inquiry</h5>
                    <div class="mb-3">
                        <label for="clientName" class="form-label">Full Name (as per ID)</label>
                        <input type="text" class="form-control form-control-lg" id="clientName" name="clientName" placeholder="John Doe">
                        <div class="invalid-feedback">Please enter your full name.</div>
                    </div>
                    <div class="mb-3">
                        <label for="clientID" class="form-label">National ID No.</label>
                        <input type="text" class="form-control form-control-lg" id="clientID" name="clientID" placeholder="e.g., 12345678">
                        <div class="invalid-feedback">Please enter your National ID number.</div>
                    </div>
                    <div class="mb-3">
                        <label for="clientPhone" class="form-label">Phone Number</label>
                        <i class="bi bi-telephone input-icon"></i>
                        <input type="tel" class="form-control form-control-lg" id="clientPhone" name="clientPhone" placeholder="e.g., +2547XXXXXXXX">
                        <div class="invalid-feedback">Please enter your phone number.</div>
                    </div>
                    <div class="mb-3">
                        <label for="clientEmail" class="form-label">Email Address</label>
                        <i class="bi bi-envelope-fill input-icon"></i> {# Added missing icon #}
                        <input type="email" class="form-control form-control-lg" id="clientEmail" name="clientEmail" placeholder="e.g., your@example.com">
                        <div class="invalid-feedback">Please enter your email address.</div>
                    </div>
                </div> -->

                <hr class="divider" />

                <div class="form-section-title" data-bs-toggle="tooltip" title="Not required to continue">Next of Kin Details <span class="fw-normal text-muted">(Optional)</span></div>
                <div class="mb-3 position-relative">
                    <label for="next_of_kin_name" class="form-label">Next of Kin Name</label>
                    <i class="bi bi-person-bounding-box input-icon"></i>
                    <input type="text" class="form-control form-control-lg" id="next_of_kin_name" name="next_of_kin_name" placeholder="Full name of next of kin">
                </div>
                <div class="mb-4 position-relative">
                    <label for="next_of_kin_phone" class="form-label">Next of Kin Phone Number</label>
                    <i class="bi bi-telephone input-icon"></i>
                    <input type="tel" class="form-control form-control-lg" id="next_of_kin_phone" name="next_of_kin_phone" placeholder="07XXXXXXXX" data-bs-toggle="tooltip" title="e.g., +2547XXXXXXXX">
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg shadow-sm">Register</button>
                </div>
            </form>

            <div class="text-center mt-4">
                <p class="text-muted small">Already have an account?
                    <a href="{{ url_for('main.login') }}" class="font-medium text-blue-600 hover:text-blue-500">
                        Log In
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
